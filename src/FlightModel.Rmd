---
title: "Flight Model"
author: "Max Czapanskiy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
knit: (function(inputFile, encoding) { 
         out_dir <- '../analysis/reports';
         out_file <- file.path(dirname(inputFile), out_dir, 'WindProjection.html');
         rmarkdown::render(inputFile,
                           encoding = encoding, 
                           output_file = out_file);
       })
output: html_document
---
  
```{r setup, message = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(foreach)
library(RSQLite)
library(doParallel)
library(iterators)
library(glmmADMB)

# dplyr connections
MHI_db <- src_sqlite('../data/MHI_GPS.sqlite')
metadata_db <- tbl(MHI_db, 'Metadata')
tidytracks_db <- tbl(MHI_db, 'TidyTracks')
acceleration_db <- tbl(MHI_db, 'SegmentACC')

POSIX.origin = ymd('1970-01-01', tz = 'UTC')

# Load data from earlier reports
load('../data/out/TransitSegments/Segments.RData')
load('../data/out/TransitSegments/ValidSegments.RData')
load('../data/out/TransitSegments/AccSegments.RData')
load('../data/out/TransitSegments/WindSegments.RData')
```

How do seabirds modulate flight behavior in response to wind? This report seeks to answer that question by modeling the flap ratio as a function of tail- (T), crosswinds (C), and trip leg (T) with BirdID as a random effect.

First up: segment sampling. Randomly select both an outbound and inbound segment from each eligible trip (i.e. not trips with just outbound or inbound segments).
```{r sample_segments}
# Which trips have both outbound and inbound legs?
bothLegs <- windSegments %>%
  group_by(DeployID, TripID, Leg) %>%
  summarize(N = n()) %>%
  ungroup %>%
  spread(Leg, N) %>%
  mutate(Both = !is.na(Inbound) & !is.na(Outbound)) %>%
  filter(Both)

bothLegs %>%
  ggplot(aes(x = DeployID)) +
  geom_bar()

set.seed(211)
segSample <- windSegments %>%
  semi_join(bothLegs, by = 'TripID') %>%
  group_by(TripID, Leg) %>%
  sample_n(1) %>%
  ungroup

save(segSample, file = '../data/out/TransitSegments/SegSample.RData')
```

Let's look at the distribution of segments across deployments, time, and location.
```{r view_segments}
# Across deployments
ggplot(segSample, aes(x = DeployID)) +
  geom_bar() +
  labs(title = 'Segment sample: 14-48 segments from 12 trips')

# Through time
ggplot(segSample, aes(x = Start, y = DeployID)) +
  geom_point() +
  labs(x = 'Date of Segment',
       title = 'Distribution of segments between May 28 and July 17')

# In space
## TODO
## Make a map of Hawaii with points for the segments, color-coded by time.
```

Now a look at the response varible (FlapRatio) in response to the predictor variables (T, C, L)
```{r plot_vars}
# F ~ T by L
ggplot(segSample, aes(x = Tailwind, y = FlapRatio, color = Leg)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  labs(x = 'Tailwind (m/s)',
       y = 'Flap Ratio',
       title = 'Flap ratio decreases with tailwind speed') +
  theme(legend.position = 'bottom')

# F ~ C by L
ggplot(segSample, aes(x = Crosswind, y = FlapRatio, color = Leg)) +
  geom_point() +
  geom_smooth(method = 'lm', se = FALSE) +
  labs(x = 'Crosswind (m/s)',
       y = 'Flap Ratio',
       title = 'Flap ratio relationship to tailwind speed varies by leg') +
  theme(legend.position = 'bottom')

# F ~ T:C by L
# Twidth <- 2
# Cwidth <- 1
# expand.grid(Tbin = seq(-10, 10, by = Twidth),
#             Cbin = seq(0, 10, by = Cwidth)) %>%
#   mutate(meanFlap = mapply(function(t, c) {
#     result <- filter(segSample, 
#                      Tailwind >= t,
#                      Tailwind < t + Twidth,
#                      Crosswind >= c,
#                      Crosswind < c + Cwidth) %>%
#       summarize(meanFlap = mean(FlapRatio))
#     result$meanFlap
#   }, Tbin, Cbin)) %>% View
#   ggplot(aes(x = Tbin, y = Cbin, z = meanFlap)) +
#   geom_tile()
## TODO: how do a interpolate a 2d surface to F ~ T:C?
```

## Determine random effects structure
Starting with the maximal fixed effects model (F ~ T * C * L) rank the potential random effects structures (where TripID < DeployID) by AIC

```{r setup_random_effects}
# List to store random effects model formulae
re.form <- list()
# Formula of maximal fixed effects
fe.max <- FlapRatio ~ Tailwind * Crosswind * Leg

# Intercepts
re.form[[1]] <- ~ . + (1|DeployID)
re.form[[2]] <- ~ . + (1|TripID)

# Slopes by DeployID
re.form[[3]] <- ~ . +  (Tailwind|DeployID)
re.form[[4]] <- ~ . + (Crosswind|DeployID)
re.form[[5]] <- ~ . + (Leg|DeployID)

# Slopes by TripID
re.form[[6]] <- ~ . + (Tailwind|TripID)
re.form[[7]] <- ~ . + (Crosswind|TripID)
re.form[[8]] <- ~ . + (Leg|TripID)

# Multiple slopes by DeployID
re.form[[9]] <- ~ . + (Tailwind|DeployID) + (Crosswind|DeployID)
re.form[[10]] <- ~ . + (Tailwind|DeployID) + (Leg|DeployID)
re.form[[11]] <- ~ . + (Crosswind|DeployID) + (Leg|DeployID)

# Multiple slopes by TripID
re.form[[12]] <- ~ . + (Tailwind|DeployID) + (Crosswind|TripID)
re.form[[13]] <- ~ . + (Tailwind|TripID) + (Leg|TripID)
re.form[[14]] <- ~ . + (Crosswind|TripID) + (Leg|TripID)

# Interaction by DeployID
re.form[[15]] <- ~ . + (Tailwind:Crosswind|DeployID)
re.form[[16]] <- ~ . + (Tailwind:Leg|DeployID)
re.form[[17]] <- ~ . + (Crosswind:Leg|DeployID)

# Interaction by TripID
re.form[[18]] <- ~ . + (Tailwind:Crosswind|TripID)
re.form[[19]] <- ~ . + (Tailwind:Leg|TripID)
re.form[[20]] <- ~ . + (Crosswind:Leg|TripID)

# Function for converting formulae to strings
char.formula <- function(f) {
  mod.parts <- as.character(f) %>%
    gsub('FlapRatio', 'F', .) %>%
    gsub('Tailwind', 'T', .) %>%
    gsub('Crosswind', 'C', .) %>%
    gsub('Leg', 'L', .) %>%
    gsub('DeployID', 'B', .) %>%
    gsub('TripID', 'R', .)
  if(length(mod.parts) == 2)
    paste(mod.parts, collapse = ' ')
  else
    paste(mod.parts[1], mod.parts[3])
}
```

```{r fit_random_effects, eval = FALSE}
# Fit models
modCl <- makeCluster(detectCores() - 1, type = 'FORK')
registerDoParallel(modCl)
re.mod <- foreach(f = re.form) %dopar% {
  mod.formula <- update.formula(fe.max, f)
  tryCatch(glmmadmb(mod.formula, segSample, family = 'beta'), error = function(e) NULL)
}
stopCluster(modCl)

# Save random effects models
save(re.mod, file = '../data/out/Models/REmodels.RData')
```

```{r summ_random_effects}
load('../data/out/Models/REmodels.RData')
# Summarize models by AIC
re.summ <- foreach(f = re.form,
                   m = re.mod, 
                   .combine = rbind) %do% {
  re.formula <- char.formula(f)
  if(is.null(m)) {
    data.frame(Formula = re.formula,
               AIC = NA)
  } else {
    data.frame(Formula = re.formula,
               AIC = AIC(m))
  }
} %>%
  mutate(dAIC = AIC - min(AIC, na.rm = TRUE)) %>%
  arrange(dAIC)

## TODO: calculate AIC weight

# Print table
re.summ
```

Based on AIC the top ranked random effects structure is (C:L|B). (L|B) and (T:C|B) had delta AIC of 7.930 and 8.708.

## Determine fixed effects structure
Using the optimal random effects structure, determine best fitting fixed effects structure
```{r setup_mixed_effects}
# List to store fixed effects model formulae
me.form <- list()
# Formulae of optimal random effects structures
re.optim1 <- FlapRatio ~ (Crosswind:Leg|DeployID)
re.optim2 <- FlapRatio ~ (Leg|DeployID)
re.optim3 <- FlapRatio ~ (Tailwind:Crosswind|DeployID)

# Mixed effects to test with (C:L|B)
me.form[[1]] <- list(~ . + Tailwind * Crosswind * Leg, re.optim1)
me.form[[2]] <- list(~ . + Crosswind * Leg + Tailwind, re.optim1)
me.form[[3]] <- list(~ . + Crosswind * Leg, re.optim1)

# Mixed effects to test with (L|B)
me.form[[4]] <- list(~ . + Tailwind * Crosswind * Leg, re.optim2)
me.form[[5]] <- list(~ . + Tailwind * Crosswind + Leg, re.optim2)
me.form[[5]] <- list(~ . + Tailwind + Crosswind * Leg, re.optim2)
me.form[[6]] <- list(~ . + Tailwind * Leg + Crosswind, re.optim2)
me.form[[7]] <- list(~ . + Tailwind + Crosswind + Leg, re.optim2)
me.form[[8]] <- list(~ . + Tailwind * Leg, re.optim2)
me.form[[9]] <- list(~ . + Tailwind + Leg, re.optim2)
me.form[[10]] <- list(~ . + Crosswind * Leg, re.optim2)
me.form[[11]] <- list(~ . + Crosswind + Leg, re.optim2)
me.form[[12]] <- list(~ . + Leg, re.optim2)

# Mixed effects to test with (T:C|B)
me.form[[13]] <- list(~ . + Tailwind * Crosswind * Leg, re.optim3)
me.form[[14]] <- list(~ . + Tailwind * Crosswind + Leg, re.optim3)
me.form[[15]] <- list(~ . + Tailwind * Crosswind, re.optim3)
```

```{r fit_mixed_effects, eval = FALSE}
# Fit models
modCl <- makeCluster(detectCores() - 1, type = 'FORK')
registerDoParallel(modCl)
me.mod <- foreach(f = me.form,
                  i = seq_along(re.form)) %dopar% {
  # Update 
  mod.formula <- update.formula(f[[2]], f[[1]])
  tryCatch(glmmadmb(mod.formula, segSample, family = 'beta'), error = function(e) NULL)
}
stopCluster(modCl)

# Save mixed effects models
save(me.mod, file = '../data/out/Models/MEmodels.RData')
```

```{r summ_mixed_effects}
load('../data/out/Models/MEmodels.RData')
# Summarize models by AIC
me.summ <- foreach(f = me.form,
                   m = me.mod, 
                   .combine = rbind) %do% {
  fe.formula <- char.formula(f[[1]])
  re.formula <- char.formula(f[[2]])
  
  if(is.null(m)) {
    data.frame(FixedEffects = fe.formula,
               RandomEffects = re.formula,
               AIC = NA)
  } else {
    data.frame(FixedEffects = fe.formula,
               RandomEffects = re.formula,
               AIC = AIC(m))
  }
} %>%
  mutate(dAIC = AIC - min(AIC, na.rm = TRUE)) %>%
  arrange(dAIC)

## TODO: calculate AIC weight

# Print table
me.summ
```

The highest ranking mixed effects model is F ~ T * C * L + (C:L | B). 

## Model diagnostics
```{r mod_summ}
flight.model <- me.mod[[1]]
summary(flight.model)

# Histogram of residuals
data.frame(residuals = residuals(flight.model)) %>%
  ggplot(aes(x = residuals)) +
  geom_histogram(binwidth = 0.1) +
  geom_vline(xintercept = 0, color = 'red') +
  labs(title = 'Distribution of residuals')

# Residuals vs fitted
data.frame(residuals = residuals(flight.model),
           fitted = fitted(flight.model)) %>%
  ggplot(aes(x = fitted, y = residuals)) +
  geom_point() +
  geom_smooth() +
  labs(title = 'Residuals vs fitted values')

# Random effect coefficient distributions
flight.model.ranef <- ranef(flight.model) %>%
  data.frame
colnames(flight.model.ranef) <- c('Intercept', 'CrossIn', 'CrossOut')
flight.model.ranef %>%
  gather(RandomEffect, Value, Intercept:CrossOut) %>%
  group_by(RandomEffect) %>%
  summarize(Lower = mean(Value) - sd(Value),
            Mean = mean(Value),
            Upper = mean(Value) + sd(Value)) %>%
  ggplot(aes(y = RandomEffect)) +
  geom_segment(aes(x = Lower, xend = Upper, yend = RandomEffect)) +
  geom_point(aes(x = Mean)) +
  labs(x = 'Regression estimates',
       y = 'Random Effect',
       title = 'Range of random effect coefficients')
```
