---
title: "Flight Model"
author: "Max Czapanskiy"
date: "`r format(Sys.time(), '%d %B, %Y')`"
knit: (function(inputFile, encoding) { 
         out_dir <- '../analysis/reports';
         out_file <- file.path(dirname(inputFile), out_dir, 'FlightModelNoLeg.html');
         rmarkdown::render(inputFile,
                           encoding = encoding, 
                           output_file = out_file);
       })
output: html_document
---
  
```{r setup, message = FALSE}
knitr::opts_chunk$set(
  message = FALSE,
  warning = FALSE
)
library(dplyr)
library(lubridate)
library(tidyr)
library(ggplot2)
library(foreach)
library(RSQLite)
library(doParallel)
library(iterators)
library(glmmADMB)
library(knitr)
library(akima)
library(rgdal)
library(geosphere)
library(spdep)
library(mosaic)
library(mgcv)
library(lme4)

# dplyr connections
MHI_db <- src_sqlite('../data/MHI_GPS.sqlite')
metadata_db <- tbl(MHI_db, 'Metadata')
tidytracks_db <- tbl(MHI_db, 'TidyTracks')
acceleration_db <- tbl(MHI_db, 'SegmentACC')

POSIX.origin = ymd('1970-01-01', tz = 'UTC')

# Load data from earlier reports
load('../data/out/TransitSegments/Segments.RData')
load('../data/out/TransitSegments/ValidSegments.RData')
load('../data/out/TransitSegments/AccSegments.RData')
load('../data/out/TransitSegments/WindSegments.RData')

select <- dplyr::select
```

How do seabirds modulate flight behavior in response to wind? This report seeks to answer that question by modeling the flap ratio as a function of tail- (`T`) and crosswinds (`C`) with individual bird (`B`) and trip (`R`) as random effects.

First up: segment sampling. Randomly select both an outbound and inbound segment from each eligible trip (i.e. trips _both_ outbound and inbound segments).
```{r sample_segments}
# Which trips have both outbound and inbound legs?
bothLegs <- windSegments %>%
  group_by(DeployID, TripID, Leg) %>%
  summarize(N = n()) %>%
  ungroup %>%
  spread(Leg, N) %>%
  mutate(Both = !is.na(Inbound) & !is.na(Outbound)) %>%
  filter(Both)

set.seed(211)
segSample <- windSegments %>%
  semi_join(bothLegs, by = 'TripID') %>%
  group_by(TripID, Leg) %>%
  sample_n(1) %>%
  ungroup %>%
  mutate(AirSpd = sqrt((meanSpd - Tailwind)^2 + Crosswind^2)) 

save(segSample, file = '../data/out/TransitSegments/SegSample.RData')
```

Let's look at the distribution of segments across deployments, time, and location.
```{r view_segments}
# Across deployments
ggplot(segSample, aes(x = DeployID)) +
  geom_bar() +
  labs(title = 'Segment sample: 14-48 segments from 12 individuals')

# Through time
ggplot(segSample, aes(x = Start, y = DeployID)) +
  geom_point() +
  labs(x = 'Date of Segment',
       title = 'Distribution of segments between May 28 and July 17')

# In space
ColLon <- -159.3997
ColLat <- 22.22888
LonExtent <- c(min(ColLon, segSample$Longitude), max(ColLon, segSample$Longitude))
LatExtent <- c(min(ColLat, segSample$Latitude), max(ColLat, segSample$Latitude))
hi_shp <- readOGR('../data/coastline/ne_10m_coastline/', 'ne_10m_coastline')
hi_df <- fortify(hi_shp) %>%
  filter(between(long, LonExtent[1], LonExtent[2]),
         between(lat, LatExtent[1], LatExtent[2]))
ggplot(segSample) +
  geom_path(data = hi_df, aes(x = long, y = lat, group = group)) +
  geom_point(aes(x = Longitude, y = Latitude, color = Start)) +
  coord_map() +
  theme(legend.position = 'bottom')
```

Now a look at the response varibles (F, O) in response to the predictor variables (T, C, A, M)
```{r plot_vars}
# F ~ T
ggplot(segSample, aes(x = Tailwind, y = FlapRatio)) +
  geom_point() +
  geom_smooth(method = 'loess') +
  labs(x = 'Tailwind (m/s)',
       y = 'Flap Ratio',
       title = 'Flap ratio decreases with tailwind speed') +
  theme(legend.position = 'bottom')

# F ~ C
ggplot(segSample, aes(x = Crosswind, y = FlapRatio, color = factor(Tailwind > 0, labels = c('Tailwind', 'Headwind')))) +
  geom_point() +
  geom_smooth(method = 'loess') +
  labs(x = 'Crosswind (m/s)',
       y = 'Flap Ratio',
       color = 'Tailwind/Headwind',
       title = 'Flap Ratio Converges in Increasing Crosswinds ') +
  theme(legend.position = 'bottom')

# F ~ T:C
ggplot(segSample, aes(x = Tailwind * Crosswind, y = FlapRatio)) +
  geom_point() +
  geom_smooth(method = 'loess') +
  labs(x = 'Tailwind * Crosswind (m^2/s^2)',
       y = 'Flap Ratio',
       title = 'Flap ratio relationship to tailwind:crosswind') +
  theme(legend.position = 'bottom')

Cross <- seq(0, 11, by = 1); Cstep <- Cross[2] - Cross[1];
Tail <- seq(-11, 11, by = 1); Tstep <- Tail[2] - Tail[1];
expand.grid(Crosswind = Cross, Tailwind = Tail) %>%
  mutate(FlapRatio = mapply(Tailwind, Crosswind,
                            FUN = function(T1, C1) {
                              points <- filter(segSample,
                                               Tailwind >= T1,
                                               Tailwind < T1 + Tstep,
                                               Crosswind >= C1,
                                               Crosswind < C1 + Cstep)
                              if(nrow(points) == 0) 
                                NA 
                              else
                                mean(points$FlapRatio, na.rm = TRUE)
                            })) %>% 
  ggplot(aes(x = Tailwind, y = Crosswind, fill = FlapRatio)) +
  geom_raster() +
  scale_fill_distiller(palette = 'RdYlBu')

# F ~ A
ggplot(segSample, aes(x = WindAngle, y = FlapRatio, color = WindSpd)) +
  geom_point() +
  geom_smooth(method = 'loess') +
  labs(x = 'Wind Angle',
       y = 'FlapRatio',
       title = 'Mean ODBA decreases with tailwinds, flat with headwinds') +
  theme(legend.position = 'bottom') +
  scale_x_continuous(breaks = pi/4 *0:4,
                     labels = c('0', 'pi/4', 'pi/2', '3pi/4', 'pi'),
                     name = 'Tailwind  <---  Wind Angle  --->  Headwind')

ggplot(segSample, aes(x = WindAngle, y = FlapRatio, color = WindSpd)) +
  geom_point() +
  geom_smooth(method = 'loess') +
  labs(x = 'Wind Angle',
       y = 'FlapRatio') +
  theme(legend.position = 'bottom') +
  scale_x_continuous(breaks = pi/4 * 0:4,
                     labels = c('0', 'pi/4', 'pi/2', '3pi/4', 'pi'),
                     name = 'Tailwind  <---  Wind Angle  --->  Headwind')
```

First pass at modeling. The primary factor determining FlapRatio appears to be WindAngle. It's an asymptotic relationship approaching 0.35.
```{r}
flapratio.mod <- nls(FlapRatio ~ SSasymp(WindAngle, Asym, R0, lrc), data = segSample)
summary(flapratio.mod)
ggplot(segSample, aes(x = WindAngle, y = FlapRatio)) +
  geom_point() +
  geom_smooth(color = 'Blue', se = FALSE) +
  geom_smooth(method = 'nls', 
              formula = y ~ SSasymp(x, Asym, R0, lrc), 
              color = 'Red', 
              se = FALSE) +
  geom_hline(color = 'green', yintercept = 0.35) +
  labs(x = 'Wind Angle',
       y = 'FlapRatio') +
  theme(legend.position = 'bottom') +
  scale_x_continuous(breaks = pi/4 * 0:4,
                     labels = c('0', 'pi/4', 'pi/2', '3pi/4', 'pi'),
                     name = 'Tailwind  <---  Wind Angle  --->  Headwind')
```

Does WindSpd explain residuals? No. The residuals around the bulk of wind speeds (6-11m/s) are balanced.
```{r}
segSample %>%
  mutate(predFlapRatio = predict(windangle.mod),
         residFlapRatio = resid(windangle.mod)) %>%
  ggplot(aes(x = WindSpd, y = residFlapRatio)) +
  geom_point() +
  geom_smooth()
```

Is there inter-individual variation? Yes, quite a lot. The shape is similar (asymptotic) but different asymptotes.
```{r, eval = FALSE}
ggplot(segSample, aes(x = WindAngle, y = FlapRatio)) +
  geom_point() +
  geom_smooth(method = 'nls', 
              formula = y ~ SSasymp(x, Asym, R0, lrc), 
              color = 'Red', 
              se = FALSE) +
  facet_wrap(~ DeployID) +
  labs(x = 'Wind Angle',
       y = 'FlapRatio') +
  theme(legend.position = 'bottom') +
  scale_x_continuous(breaks = pi/4 * 0:4,
                     labels = c('0', 'pi/4', 'pi/2', '3pi/4', 'pi'),
                     name = 'Tailwind  <---  Wind Angle  --->  Headwind')
```

Thus a mixed-effects nonlinear model. HOW?
```{r, eval = FALSE}
windangle.memod <- nlme(FlapRatio ~ SSasymp(WindAngle, Asym, R0, lrc), 
                        data = segSample,
                        fixed = Asym + R0 + lrc ~ 1,
                        random = Asym ~ DeployID)
summary(windangle.mod)
ggplot(segSample, aes(x = WindAngle, y = FlapRatio)) +
  geom_point() +
  geom_smooth(color = 'Blue', se = FALSE) +
  geom_smooth(method = 'nls', 
              formula = y ~ SSasymp(x, Asym, R0, lrc), 
              color = 'Red', 
              se = FALSE) +
  geom_hline(color = 'green', yintercept = 0.35) +
  labs(x = 'Wind Angle',
       y = 'FlapRatio') +
  theme(legend.position = 'bottom') +
  scale_x_continuous(breaks = pi/4 * 0:4,
                     labels = c('0', 'pi/4', 'pi/2', '3pi/4', 'pi'),
                     name = 'Tailwind  <---  Wind Angle  --->  Headwind')
```

Does ODBA respond to FlapRatio? Yes, asymptotically There's an upper asymptote around 8.8 m/2^s. But nls isn't fitting asymptote, so we'll just use the linear.
```{r}
ggplot(segSample, aes(x = FlapRatio, y = MeanODBA)) +
  geom_point() +
  geom_smooth()

# nls.control(minFactor = 1e-6)
# ODBA.mod <- nls(MeanODBA ~ SSasymp(FlapRatio, Asym, R0, lrc), segSample)

ODBA.mod <- lm(MeanODBA ~ FlapRatio, segSample)
summary(ODBA.mod)
segSample %>%
  mutate(mod.resid = residuals(ODBA.mod)) %>%
  ggplot(aes(sample = mod.resid / sd(mod.resid))) +
  stat_qq() +
  geom_abline(slope = 1, intercept = 0, color = 'darkred') +
  labs(title = 'Residual Q-Q')

segSample %>%
  mutate(predODBA = predict(ODBA.mod)) %>%
  ggplot(aes(x = FlapRatio, y = MeanODBA)) +
  geom_point() +
  geom_smooth(color = 'Blue', se = FALSE) +
  geom_line(aes(y = predODBA), color = 'Red', size = 1.5) +
  labs(x = 'Flap Ratio',
       y = 'ODBA (m/s^2)')

```

ODBA is supposed to be a linear predictor of energy expenditure (per time, so power). Time is a function of ground speed, which grows quadratically with tailwind.
```{r}
grdspd.mod <- lm(meanSpd ~ poly(Tailwind, 2), segSample)
summary(grdspd.mod)
ggplot(segSample, aes(x = Tailwind, y = meanSpd)) +
  geom_point() +
  geom_smooth(color = 'Red', method = 'lm', formula = y ~ poly(x, 2))
```

Energy expenditure is therefore a function of WindAngle and Tailwind. Power (i.e. ODBA) is derived from ODBA ~ FlapRatio, FlapRatio ~ WindAngle. Time is distance over ground speed.

```{r}
# Parameters
distance <- 100e3 # 100km
typical.wind <- segSample %>% 
                 summarize(U = mean(uWind), 
                           V = mean(vWind))
wind.spd <- with(typical.wind, sqrt(U^2 + V^2)) # m/s
wind.azimuth <- with(typical.wind, atan2(V, U)) # radians

get.wind.angle <- function(trip.az) {
  theta <- trip.az - wind.azimuth
  (theta + pi) %% (2*pi) - pi
}

flight.time <- function(trip.az) {
  wind.angle <- get.wind.angle(trip.az)
  tailwind <- wind.spd * cos(wind.angle)
  ground.spd <- predict(grdspd.mod, data.frame(Tailwind = tailwind))
  distance / ground.spd
}

power <- function(trip.az) {
  wind.angle <- get.wind.angle(trip.az)
  flap.ratio <- predict(flapratio.mod, data.frame(WindAngle = abs(wind.angle)))
  predict(ODBA.mod, data.frame(FlapRatio = flap.ratio))
}

energy <- function(trip.az) {
  power(trip.az) * flight.time(trip.az)
}

AzimuthSelection <- data.frame(TripAzimuth = seq(-pi, pi, length.out = 100)) %>%
  mutate(WindAngleOut = get.wind.angle(TripAzimuth),
         FlightTimeOut = flight.time(TripAzimuth),
         PowerOut = power(TripAzimuth),
         EnergyOut = energy(TripAzimuth),
         AzimuthIn = ifelse(TripAzimuth < 0, TripAzimuth + pi, TripAzimuth - pi),
         WindAngleIn = get.wind.angle(AzimuthIn),
         FlightTimeIn = flight.time(AzimuthIn),
         PowerIn = power(AzimuthIn),
         EnergyIn = energy(AzimuthIn),
         TotalFlightTime = FlightTimeOut + FlightTimeIn,
         TotalEnergy = EnergyOut + EnergyIn)
  
radian.breaks <- seq(-pi, pi, by = pi/2)
radian.labels <- c('-pi', '-pi/2', '0', 'pi/2', 'pi')

# Wind Angle
AzimuthSelection %>%
  gather(Direction, WindAngle, WindAngleOut, WindAngleIn) %>% 
  ggplot(aes(x = TripAzimuth, y = WindAngle, color = Direction)) +
  geom_line() +
  geom_vline(xintercept = wind.azimuth) +
  scale_x_continuous(breaks = radian.breaks, labels = radian.labels) +
  scale_y_continuous(breaks = radian.breaks, labels = radian.labels)

# Flight Time
AzimuthSelection %>%
  gather(Direction, FlightTime, FlightTimeOut, FlightTimeIn, TotalFlightTime) %>% 
  mutate(FlightTimeHours = FlightTime / 3600) %>%
  ggplot(aes(x = TripAzimuth, y = FlightTimeHours, color = Direction)) +
  geom_line() +
  geom_vline(xintercept = wind.azimuth) +
  scale_x_continuous(breaks = radian.breaks, labels = radian.labels)

# Power
AzimuthSelection %>%
  gather(Direction, Power, PowerOut, PowerIn) %>% 
  ggplot(aes(x = TripAzimuth, y = Power, color = Direction)) +
  geom_line() +
  geom_vline(xintercept = wind.azimuth) +
  scale_x_continuous(breaks = radian.breaks, labels = radian.labels)

# Energy
AzimuthSelection %>%
  gather(Direction, Energy, EnergyOut, EnergyIn, TotalEnergy) %>% 
  ggplot(aes(x = TripAzimuth, y = Energy, color = Direction)) +
  geom_line() +
  geom_vline(xintercept = wind.azimuth) +
  scale_x_continuous(breaks = radian.breaks, labels = radian.labels)
```

```{r}
# More segments were in tail-/headwinds than crosswinds
segSample %>%
  mutate(WindAngle = derivedFactor(Headwind = -Tailwind >= Crosswind,
                                   Tailwind = Tailwind >= Crosswind,
                                   Crosswind = abs(Tailwind) < Crosswind)) %>%
  ggplot(aes(x = WindAngle)) +
  geom_bar()

segSample2 <- mutate(segSample, 
                     WindAngle = atan2(Crosswind, Tailwind),
                     AirSpeed = sqrt((meanSpd - Tailwind)^2 + Crosswind^2))

# Flap ratio decreases as tailwinds increase, but flat in all headwinds
ggplot(segSample2, aes(x = WindAngle, y = FlapRatio)) +
  geom_smooth(method = 'gam', formula = y ~ s(x)) +
  geom_point() +
  scale_x_continuous(breaks = pi/4 *0:4, 
                     labels = c('0', 'pi/4', 'pi/2', '3pi/4', 'pi'))

flap.gam <- gamm(FlapRatio ~ s(WindAngle), 
                 random = list(DeployID = ~1), 
                 family = gaussian(link = 'identity'),
                 data = segSample2)

# Air speed
ggplot(segSample2, aes(x = Tailwind, y = AirSpeed, color = Crosswind)) +
  geom_point() +
  geom_smooth(method = 'gam', formula = y ~ s(x)) +
  scale_color_distiller(palette = 'RdBu')

airspd.lm <- lmer(AirSpeed ~ Tailwind + (1|DeployID), data = segSample2)
mutate(segSample2,
       airspd.resid = resid(airspd.lm)) %>%
  ggplot(aes(sample = airspd.resid / sd(airspd.resid))) +
  stat_qq() +
  geom_abline(slope = 1, intercept = 0, color = 'darkred') +
  labs(title = 'Residual Q-Q plots') +
  coord_fixed()

wind.spd <- 8.1 # m/s
mass <- 1060 # g
distance <- 100e3 # m
# Assume work is a weighted average of flap/glide. See Duerr et al. 2012 for flap/glide
# power ratio. See Raymond et al. 2010 for E ~ Va. See Ballance 1995 for RFBO parameters
W <- function(Va) {
  S <- 0.2 # m^2
  q <- 9.7 # W (RMR)
  # What's r?
  q + 1/Va + S * Va^3
}
Wfg <- function(fg, Va) {
  w <- W(Va)
  w * mass ^ 1.17 * fg + w * mass ^ 0.78 * (1 - fg)
}
E <- function(W, d, Vg) {
  W * d / Vg
}
Vg <- function(Va, t, c) {
  sqrt(Va^2 - c^2) + t
}
Va <- function(t) {
  predict(airspd.lm, newdata = data.frame(Tailwind = t), re.form = NA)
}
foo <- data.frame(windAngle = seq(0, pi, length.out = 20)) %>%
  mutate(TOut = wind.spd * cos(windAngle),
         TIn = wind.spd * cos(pi - windAngle),
         COut = wind.spd * sin(windAngle),
         CIn = wind.spd * sin(pi - windAngle),
         FOut = predict(flap.gam$gam, 
                        newdata = data.frame(WindAngle = windAngle)),
         FIn = predict(flap.gam$gam, 
                       newdata = data.frame(WindAngle = pi - windAngle)),
         FNet = (FOut + FIn) / 2,
         VaOut = Va(TOut),
         VaIn = Va(TIn),
         VgOut = Vg(VaOut, TOut, COut),
         VgIn = Vg(VaIn, TIn, CIn),
         WOut = Wfg(FOut, VaOut),
         WIn = Wfg(FIn, VaIn),
         EOut = E(WOut, distance, VgOut),
         EIn = E(WIn, distance, VgIn),
         ETot = EOut + EIn)

foo %>%
  gather(key = Direction, value = energy, EOut:ETot) %>%
  ggplot(aes(x = windAngle, y = energy, color = Direction)) +
  geom_line() +
  scale_x_continuous(breaks = pi/4 *0:4, 
                     labels = c('0', 'pi/4', 'pi/2', '3pi/4', 'pi'))
```
