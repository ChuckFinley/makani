---
title: "Transit Segments"
author: "Max Czapanskiy"
date: "June 6, 2017"
output: html_document
---

```{r setup, echo = FALSE, message = FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE
)
library(dplyr)
library(tidyr)
library(mosaic)
library(lubridate)
library(geosphere)
library(RSQLite)
library(dbplyr)
library(zoo)
library(knitr)
library(foreach)
library(iterators)
library(RNetCDF)
library(abind)
library(data.table)
library(lme4)
library(tcltk)
select <- dplyr::select
between <- dplyr::between
lead <- dplyr::lead
month <- lubridate::month

# dplyr connections
MHI_db <- src_sqlite('../MHI_GPS_TDR.sqlite')
metadata_db <- tbl(MHI_db, 'Metadata')
tracks_db <- tbl(MHI_db, sql('SELECT * FROM TrackView'))
trips_db <- tbl(MHI_db, sql('SELECT * FROM Trips'))
tidytracks_db <- tbl(MHI_db, 'TidyTracks')

POSIX.origin = ymd('1970-01-01', tz = 'UTC')
```

## Identify Transit Segments
Transit segments are the new basis of analysis for ODBA ~ wind. We'll only analyze single-day trips.

Here we define a transit segment as the following:

* 30 minutes (i.e. 15 consecutive points)
* No gaps longer than 150% of the scheduled sampling rate (i.e. 3 minutes)
* Standard deviation of speed < 1.5m/s
* At least 13 of the 15 points are classified as transit by the RST algorithm (Torres et al. 2017)
* Net displacement of more than 10km

```{r segments, cache=TRUE}
tracks <- tidytracks_db %>%
  filter(Species == 'RFBO',
         Year == 2016,
         PositionLag <= 180) %>%
  collect(n = Inf) %>%
  group_by(TripID) %>%
  filter((max(TimestampUTC) - min(TimestampUTC)) / 3600 < 24,
         n() >= 15) %>%
  ungroup %>%
  mutate(TimestampUTC = as.POSIXct(TimestampUTC, origin = POSIX.origin, tz = 'UTC'))

window <- 15
leadWindow <- window - 1
getLeg <- function(d2c) {
  m <- lm(d2c ~ seq_along(d2c))
  if(coefficients(m)[2] > 0)
    'Outbound'
  else
    'Inbound'
}

meanBear <- function(lonlat) {
  lon <- lonlat[,1]
  lat <- lonlat[,2]
  m <- lm(lat ~ lon)
  pLat <- predict(m)
  bearing(c(first(lon), first(pLat)), c(last(lon), last(pLat)))
}

segments0 <- tracks %>%
  arrange(TripID, TimestampUTC) %>%
  group_by(TripID) %>%
  mutate(Start = TimestampUTC,
         End = lead(TimestampUTC, leadWindow),
         Leg = rollapply(DistToCol, window, getLeg, fill = NA, partial = FALSE, align = 'left'),
         maxGap = rollapply(TimestampUTC, window, function(t) max(as.numeric(lead(t) - t, units = 'secs'), na.rm = TRUE), fill = NA, partial = FALSE, align = 'left'),
         meanSpd = rollapply(Speed, window, mean, fill = NA, partial = FALSE, align = 'left'),
         sdSpd = rollapply(Speed, window, sd, fill = NA, partial = FALSE, align = 'left'),
         meanTrt = rollapply(Tortuosity, window, mean, fill = NA, partial = FALSE, align = 'left'),
         nTransit = rollapply(Behavior, window, function(b) sum(b == 'transit'), fill = NA, partial = FALSE, align = 'left'),
         displacement = distGeo(cbind(Longitude, Latitude), cbind(lead(Longitude, leadWindow), lead(Latitude, leadWindow))),
         bearing = rollapply(data.frame(Longitude, Latitude), window, meanBear, by.column = FALSE, fill = NA, partial = FALSE, align = 'left')) %>%
  select(TripID, Longitude, Latitude, Start:bearing)

segments <- filter(segments0,
                   maxGap <= 180,
                   sdSpd < 1.5,
                   nTransit > 12,
                   displacement > 1e4)

write.csv(segments0, '../TransitSegments/Segments0.csv', row.names = FALSE)
write.csv(segments, '../TransitSegments/Segments.csv', row.names = FALSE)
```

## Summarize Results

*How many trips have inbound and/or outbound segments?*

Of the 644 single-day trips:

* 330 have outbound transit segments
* 440 have inbound transit segments
* 238 have transit segments in both directions

*How many birds have trips with both inbound and outbound segments?*

All 15! However, 1147 and 1156 had only 1 and 2 such trips, respectively. The next lowest are 1152 and 1155 with 6 and 7. The greatest is 1153 with 38.

```{r summarize, results = 'asis'}
segPerTrip0 <- segments %>%
  group_by(TripID, Leg) %>%
  summarize(N = n())

# This table has the number of segments for every combination of TripID + Leg
segPerTrip <- expand.grid(TripID = unique(tracks$TripID), Leg = c('Inbound', 'Outbound')) %>%
  left_join(segPerTrip0) %>%
  arrange(TripID, Leg) %>%
  spread(Leg, N)

# How many trips have inbound and/or outbound segments?
segPerTrip %>% summarize(noOut = sum(is.na(Outbound)), 
                         yesOut = sum(!is.na(Outbound)), 
                         noIn = sum(is.na(Inbound)), 
                         yesIn = sum(!is.na(Inbound)), 
                         noBoth = sum(is.na(Outbound) & is.na(Inbound)), 
                         yesBoth = sum(!is.na(Outbound) & !is.na(Inbound))) %>%
  kable(format = 'html', table.attr = "style='width:35%;'")

# How many birds have trips with both inbound and outbound segments?
segPerTrip %>%
  mutate(DeployID = as.numeric(substr(TripID, 1, 4))) %>%
  group_by(DeployID) %>%
  summarize(nBoth = sum(!is.na(Outbound) & !is.na(Inbound))) %>%
  kable(format = 'html', table.attr = "style='width:15%;'")
```

## Inbound/Outbound Comparison

*Do birds fly faster when returning to the colony?*

To test if flight speed is dependent on trip leg, I sampled five trips from each bird (except 1147 and 1156) then sampled one outbound and inbound transit segment from each trip.

* H0: No difference in the mean of speed between outbound and inbound legs.
* HA: The mean speed of inbound legs is higher than outbound legs.
* alpha: 0.05

```{r inout, cache=TRUE}
# Sample ten trips from each bird with at least that many valid trips (inbound + outbound segment).
# Excludes 1146, 1147, 1152, 1155, 1156.
set.seed(2017)
inoutTrips <- segPerTrip %>%
  mutate(DeployID = as.numeric(substr(TripID, 1, 4))) %>%
  filter(!is.na(Outbound) & !is.na(Inbound)) %>%
  group_by(DeployID) %>%
  filter(n() >= 10) %>%
  sample_n(10)

# Sample one inbound and one outbound segment from each trip
set.seed(1988)
inoutSegments <- segments %>%
  filter(TripID %in% inoutTrips$TripID) %>%
  group_by(TripID, Leg) %>%
  sample_n(1) %>%
  mutate(DeployID = as.numeric(substr(TripID, 1, 4))) %>%
  ungroup %>%
  mutate(SegmentID = row_number())
outSpd <- inoutSegments$meanSpd[inoutSegments$Leg == 'Outbound']
inSpd <- inoutSegments$meanSpd[inoutSegments$Leg == 'Inbound']

# When are the trips?
tracks %>%
  group_by(DeployID, TripID) %>%
  summarize(TripStart = with_tz(first(TimestampUTC), 'US/Hawaii'),
            TripEnd = with_tz(last(TimestampUTC), 'US/Hawaii')) %>% 
  mutate(Month = month(TripStart)) %>% 
  ggplot(aes(x = TripStart, y = DeployID)) +
  geom_segment(aes(xend = TripEnd, yend = DeployID)) +
  geom_point(data = inoutSegments,
             aes(x = Start, y = DeployID)) +
  theme(legend.position = 'None') +
  scale_y_continuous(breaks = unique(tracks$DeployID)) +
  labs(title = 'Temporal Distribution of Sampled Trips',
       x = 'Date',
       caption = 'Lines = Trips, Points = Transit Segments')

 # Plot distributions
ggplot(inoutSegments,
       aes(x = Leg, y = meanSpd, fill = Leg)) +
  geom_boxplot(notch = TRUE) +
  geom_hline(yintercept = c(mean(outSpd), mean(inSpd)), linetype = 'dashed') +
  labs(title = 'Flight Speed by Trip Leg',
       caption = 'Dashed lines indicate mean flight speed',
       y = 'Speed (m/s)') +
  theme(legend.position = 'None')

inoutTest <- t.test(outSpd, inSpd, paired = TRUE, alternative = 'less')

save(segments0, segments, segPerTrip, inoutSegments, file = '../TransitSegments/segments.RData')
```

Results:

* Mean inbound speed = 13.47m/s
* Mean outbound speed = 9.66m/s
* t = -10.37
* df = 99
* p < 2.2e-16

Conclusion:
Reject the null hypothesis. Birds fly significantly faster when returning to the colony than leaving.

## Transit Acceleration
Pick out the acceleration data from the transit segments to plot raw values and examine ODBA patterns. Had to exclude one segment from trip (115500001) due to missing ACC data.

```{r transitAcc, cache = TRUE}
load('../TransitSegments/segments.RData')

accMeta <- metadata_db %>%
  filter(Species == 'RFBO',
         Year == 2016) %>%
  select(DeployID, GPS_ID) %>%
  collect %>% 
  mutate(GPS_ID = as.integer(GPS_ID)) %>%
  left_join(read.csv('../E-Obs/Calibration/calib_const.csv'),
            by = c('GPS_ID' = 'TagID'))

segmentsACCmeta <- inoutSegments %>%
  left_join(accMeta, by = 'DeployID') %>%
  as.data.frame %>%
  arrange(DeployID, TripID)

acc.data <- NULL
did <- 0
pb <- tkProgressBar(min = 1, max = nrow(segmentsACCmeta), width = 300)
segmentsACC <- foreach(segment = iter(segmentsACCmeta, by = 'row'), .combine = rbind) %do%{
  setTkProgressBar(pb, segment$SegmentID, label = sprintf('TripID %i, Leg %s', segment$TripID, segment$Leg))
  tryCatch({
    if(segment$DeployID != did) {
      did <<- segment$DeployID
      acc.file <- sprintf('../E-Obs/ClippedACC/%s.csv', segment$GPS_ID)
      acc.data <<- read.csv(acc.file, stringsAsFactors = FALSE) %>%
        mutate(TimestampUTC = as.POSIXct(timestamp, format = '%Y-%m-%d %H:%M:%OS', tz = 'UTC'),
               BurstID = row_number()) %>%
        select(TimestampUTC, BurstID,
               acc.raw = eobs.accelerations.raw, 
               acc.freq = eobs.acceleration.sampling.frequency.per.axis)
    }
    
    burst.data <- filter(acc.data,
                         TimestampUTC >= segment$Start,
                         TimestampUTC <= segment$End) %>% 
      cbind(segment, row.names = NULL)
                                   
    foreach(burst = iter(burst.data, by = 'row'), .combine = rbind) %do% {
      acc.split <- strsplit(burst$acc.raw, ' ') %>%
        unlist %>%
        as.numeric %>%
        matrix(ncol = 3, byrow = TRUE, dimnames = list(NULL, c('X0', 'Y0', 'Z0'))) %>%
        as.data.frame
      
      burst %>%
        select(-acc.raw) %>%
        cbind(acc.split, row.names = NULL) %>%
        mutate(ACCTimestampUTC = TimestampUTC + (seq_along(X0) - 1) / acc.freq,
               X = bX + mX * X0,
               Y = bY + mY * Y0,
               Z = bZ + mZ * Z0,
               staticX = mean(X),
               staticY = mean(Y),
               staticZ = mean(Z),
               dynX = X - staticX,
               dynY = Y - staticY,
               dynZ = Z - staticZ,
               varDynZ = rollapply(dynZ, 11, var, fill = NA, partial = FALSE, align = 'center'),
               ODBA = mapply(sum, abs(dynX), abs(dynY), abs(dynZ)),
               varODBA = rollapply(ODBA, 11, var, fill = NA, partial = FALSE, align = 'center'))
    }
  }, error = function(e) browser())
}

save(segmentsACC, segments0, segments, segPerTrip, inoutSegments, file = '../TransitSegments/segmentsACC.RData')
```

From visual inspection, threshold for flap/glide is var(ODBA) = 50. 

```{r plot}
plot.segmentACC <- function(segmentID) {
  plot.data <- segmentsACC %>%
    filter(SegmentID == segmentID) %>%
    mutate(FlapGlide = derivedFactor(Flap = varODBA >= 50,
                                     Glide = varODBA < 50))
  
  tid <- plot.data$TripID[1]
  leg <- plot.data$Leg[1]
  start <- format(plot.data$Start[1], format = '%m-%d %H:%M')
  
  p <- ggplot(plot.data, aes(ACCTimestampUTC, dynZ)) +
    geom_line(size = 0.5) +
    geom_point(aes(color = FlapGlide), size = 1) +
    facet_wrap(~ BurstID, scales = 'free_x') +
    labs(title = sprintf('ODBA Along Transit Segment %i', segmentID),
         caption = sprintf('TripID %i %s leg beginning %s',
                           tid,
                           leg,
                           start),
         x = 'Time (s)',
         y = 'Acceleration (m/s^2)') +
    ylim(0, 50) + 
    theme_bw(base_size = 9)
  
  ggsave(sprintf('../TransitSegments/ACCplots/ACCseg%i.png', segmentID), plot = p, width = 16, height = 9, units = 'in')
}
```

Does flap/glide ratio vary w/ ground speed?

```{r FGspeed}
load('../TransitSegments/segments.RData')
FGr.data <- segmentsACC %>%
  group_by(SegmentID) %>%
  mutate(FlapGlide = derivedFactor(Flap = varODBA >= 50,
                                   Glide = varDynZ < 50)) %>%
  summarize(Flap = sum(FlapGlide == 'Flap', na.rm = TRUE),
            Glide = sum(FlapGlide == 'Glide', na.rm = TRUE)) %>%
  mutate(N = Flap + Glide,
         FGr = Flap / N) %>%
  left_join(distinct(segmentsACC, SegmentID, TripID, meanSpd, DeployID, Leg))

# Distribution of FGr by DeployID is fairly consistent with one outlier: 1145 glides more than the others
ggplot(FGr.data, aes(x = FGr, color = DeployID)) +
  geom_density() +
  labs(x = 'Flap/Glide Ratio',
       title = 'Distribution of Flap/Glide Ratio by Individual')

# FGr decreases with ground speed
ggplot(FGr.data, aes(x = meanSpd, y = FGr)) +
  geom_point() +
  geom_smooth(method = 'lm') +
  facet_wrap(~ DeployID) +
  labs(x = 'Ground Speed (m/s)',
       y = 'Flap/Glide Ratio',
       title = 'Flap/Glide Ratio Decreases with Ground Speed',
       caption = 'Faceted by individual')

# FGr higher outbound than inbound - due to wind or behavior?
ggplot(FGr.data, aes(x = DeployID, y = FGr, fill = Leg)) +
  geom_boxplot() +
  labs(x = 'Individual',
       y = 'Flap/Glide Ratio',
       title = 'Flap/Glide Ratio Greater in Outbound than Inbound Legs')

# Linear mixed effects model
FGrSpeedMod <- lmer(FGr ~ meanSpd + Leg + (1+meanSpd|DeployID) + (1+Leg|DeployID), data = FGr.data)
summary(FGrSpeedMod)
coefficients(FGrSpeedMod)
FGrSpeedModPred <- expand.grid(Leg = unique(FGr.data$Leg),
                               meanSpd = range(FGr.data$meanSpd),
                               DeployID = unique(FGr.data$DeployID)) %>%
  mutate(FGr = predict(FGrSpeedMod, .))

# Model results. How do I get CIs? 1145 is still clearly an outlier.
ggplot(FGr.data, aes(x = meanSpd, y = FGr, color = Leg)) +
  geom_point() +
  geom_line(data = FGrSpeedModPred) +
  facet_wrap(~ DeployID) +
  labs(x = 'Ground Speed (m/s)',
       y = 'Flap/Glide Ratio',
       title = 'Results of LME Model',
       caption = 'FGr ~ meanSpd + Leg + (1+meanSpd|DeployID) + (1+Leg|DeployID)')
```

Does flap/glide ratio vary w/ wind speed?

The full wind data set for 2016 was too large to download in one file. I downloaded monthly data in four separate files (Jun-Sep). Here I concatenate the four files while retaining the general NCDF structure.

```{r concat_wind}
# Concatenates ncdf lists and drops duplicate points
# Assumes nc1 and nc2 are temporally adjacent and spatially contiguous
concat.wind <- function(nc1, nc2) {
  if(last(nc1$time) == first(nc2$time)) {
    nc2$Uwind <- nc2$Uwind[1:length(nc2$longitude),
                           1:length(nc2$latitude),
                           2:length(nc2$time)]
    nc2$Vwind <- nc2$Vwind[1:length(nc2$longitude),
                           1:length(nc2$latitude),
                           2:length(nc2$time)]
    nc2$time <- nc2$time[-1]
  }
  list(time = c(nc1$time, nc2$time),
       latitude = nc1$latitude,
       longitude = nc1$longitude,
       Uwind = abind(nc1$Uwind, nc2$Uwind, along = 3),
       Vwind = abind(nc1$Vwind, nc2$Vwind, along = 3))
}

wind.files <- list('../Wind/WRF_HI_Best_ef69_0644_a22b_Jun.nc',
                   '../Wind/WRF_HI_Best_42fe_56d1_4307_Jul.nc',
                   '../Wind/WRF_HI_Best_24a5_06c9_80ba_Aug.nc',
                   '../Wind/WRF_HI_Best_ab1f_5288_5f35_sep.nc')

wind.nc <- foreach(file = wind.files, .combine = concat.wind) %do% 
  read.nc(open.nc(file))
```

Append wind u and v to segments based on time and locations of first point in segment. Calculate tailwind and crosswind components from the segment's mean bearing.

```{r join_wind}
load('../TransitSegments/segments.RData')
segments.dt <- inoutSegments %>%
  mutate(dummyTime = as.numeric(Start),
         dummyLon = Longitude,
         dummyLat = Latitude) %>%
  collect(n = Inf) %>%
  data.table(key = 'dummyTime')

time.dt <- data.table(time = wind.nc$time,
                      time.idx = seq(wind.nc$time), 
                      key = 'time')
lon.dt <- data.table(lon = wind.nc$longitude,
                     lon.idx = seq(wind.nc$longitude),
                     key = 'lon')
lat.dt <- data.table(lat = wind.nc$latitude,
                     lat.idx = seq(wind.nc$latitude),
                     key = 'lat')

# Sequentially join time index, longitude index, and latitude index
segments.time <- time.dt[segments.dt, roll = Inf]
setkey(segments.time, dummyLon)
segments.lon <- lon.dt[segments.time, roll = Inf]
setkey(segments.lon, dummyLat)
segments.lat <- lat.dt[segments.lon, roll = Inf]

# Join u and v wind components and project wind onto bearing
project <- function(u1, v1, u2, v2) {
  proj <- function(a, b) {
    bmag = sqrt(b[1]^2 + b[2]^2)
    (a %*% b) / bmag
  }
  cbind(u1, v1, u2, v2) %>%
    apply(MARGIN = 1, FUN = function(row) proj(row[1:2], row[3:4]))
}
reject <- function(u1, v1, proj) {
  rej <- function(a, proj) {
    amag2 = a[1]^2 + a[2]^2
    sqrt(amag2 - proj^2)
  }
  cbind(u1, v1, proj) %>%
    apply(MARGIN = 1, FUN = function(row) rej(row[1:2], row[3]))
}
segmentsUV <- mutate(segments.lat,
                     U = wind.nc$Uwind[cbind(lon.idx, lat.idx, time.idx)],
                     V = wind.nc$Vwind[cbind(lon.idx, lat.idx, time.idx)],
                     bearing = (90 - bearing) * pi / 180,
                     tailwind = project(U, V, cos(bearing), sin(bearing)),
                     crosswind = reject(U, V, tailwind)) %>%
  arrange(SegmentID)

save(segmentsUV, segmentsACC, segments0, segments, segPerTrip, inoutSegments, file = '../TransitSegments/segmentsACC.RData')
```

```{r plot.segment.WindACC}
library(maps)
library(mapdata)
library(grid)
library(gridExtra)
plot.trip.WindACC <- function(tripid) {
  track <- tidytracks_db %>%
    filter(TripID == tripid) %>%
    collect(n = Inf) %>%
    mutate(TimestampUTC == as.POSIXct(TimestampUTC, tz = 'UTC', origin = POSIX.origin))
  outLegMeta <- filter(inoutSegments, TripID == tripid, Leg == 'Outbound')
  inLegMeta <- filter(inoutSegments, TripID == tripid, Leg == 'Inbound')
  outLeg <- track %>%
    filter(between(TimestampUTC, outLegMeta$Start, outLegMeta$End)) %>%
    select(TimestampUTC, Longitude, Latitude) %>%
    mutate(Leg = 'Outbound')
  inLeg <- track %>%
    filter(between(TimestampUTC, inLegMeta$Start, inLegMeta$End)) %>%
    select(TimestampUTC, Longitude, Latitude) %>%
    mutate(Leg = 'Inbound')
  legs <- rbind(outLeg, inLeg)
  
  margin <- 0.2
  lonRng <- range(track$Longitude)
  latRng <- range(track$Latitude)
  span <- if(lonRng[2] - lonRng[1] > latRng[2] - latRng[1]) {
    (1 + margin) * (lonRng[2] - lonRng[1])
  } else {
    (1 + margin) * (latRng[2] - latRng[1])
  }
  lonLim <- c(mean(lonRng) - span / 2, mean(lonRng) + span / 2)
  latLim <- c(mean(latRng) - span / 2, mean(latRng) + span / 2)
  
  world <- map_data('world', xlim = lonLim, ylim = latLim)
  
  mapplot <- ggplot() + 
    geom_polygon(data = world, aes(x = long, y = lat, group = group)) + 
    coord_fixed(1, lonLim, latLim) +
    geom_path(data = track, aes(x = Longitude, y = Latitude)) +
    geom_point(data = legs, aes(x = Longitude, y = Latitude, color = Leg)) +
    labs(x = 'Longitude',
         y = 'Latitude',
         title = sprintf('TripID: %i', tripid)) +
    theme_gray(base_size = 16) +
    theme(legend.position = 'bottom')
  
  outWindDf <- with(filter(segmentsUV, SegmentID == outLegMeta$SegmentID),
                    data.frame(arrow = c('Bearing',
                                         'Wind',
                                         'Tailwind',
                                         'Crosswind'),
                               label = c(sprintf('%.1fdeg', bearing * 180 / pi),
                                         sprintf('u=%.1fm/s,\nv=%.1fm/s', U, V),
                                         sprintf('%.1fm/s', tailwind),
                                         sprintf('%.1fm/s', crosswind)),
                               x0 = c(0,
                                      0,
                                      0,
                                      tailwind * cos(bearing)),
                               y0 = c(0,
                                      0,
                                      0,
                                      tailwind * sin(bearing)),
                               x1 = c(cos(bearing),
                                      U,
                                      tailwind * cos(bearing),
                                      U),
                               y1 = c(sin(bearing),
                                      V,
                                      tailwind * sin(bearing),
                                      V)))
  outWindSpan <- with(outWindDf, max(max(x0, x1) - min(x0, x1), max(y0, y1) - min(y0, y1)))
  outWindXlim <- with(outWindDf, mean(range(x0, x1)) + c(-outWindSpan / 2, outWindSpan / 2))
  outWindYlim <- with(outWindDf, mean(range(y0, y1)) + c(-outWindSpan / 2, outWindSpan / 2))
  outWindPlot <- ggplot(outWindDf) +
    geom_segment(aes(x = x0,
                     xend = x1,
                     y = y0,
                     yend = y1,
                     color = arrow),
                 size = 1.5,
                 arrow = arrow()) +
    # geom_text(aes(x = (x0 + x1) / 2,
    #               y = (y0 + y1) / 2,
    #               label = label)) +
    coord_cartesian(xlim = outWindXlim, ylim = outWindYlim) +
    labs(x = 'X', y = 'Y', color = NULL, title = 'Wind Projected onto Outbound Leg') +
    theme(legend.position = 'none')
  
  inWindDf <- with(filter(segmentsUV, SegmentID == inLegMeta$SegmentID),
                   data.frame(arrow = c('Bearing',
                                        'Wind',
                                        'Tailwind',
                                        'Crosswind'),
                              label = c(sprintf('%.1fdeg', bearing * 180 / pi),
                                        sprintf('u=%.1fm/s,\nv=%.1fm/s', U, V),
                                        sprintf('%.1fm/s', tailwind),
                                        sprintf('%.1fm/s', crosswind)),
                              x0 = c(0,
                                     0,
                                     0,
                                     tailwind * cos(bearing)),
                              y0 = c(0,
                                     0,
                                     0,
                                     tailwind * sin(bearing)),
                              x1 = c(cos(bearing),
                                     U,
                                     tailwind * cos(bearing),
                                     U),
                              y1 = c(sin(bearing),
                                     V,
                                     tailwind * sin(bearing),
                                     V)))
  inWindSpan <- with(inWindDf, max(max(x0, x1) - min(x0, x1), max(y0, y1) - min(y0, y1)))
  inWindXlim <- with(inWindDf, mean(range(x0, x1)) + c(-inWindSpan / 2, inWindSpan / 2))
  inWindYlim <- with(inWindDf, mean(range(y0, y1)) + c(-inWindSpan / 2, inWindSpan / 2))
  inWindPlot <- ggplot(inWindDf) +
    geom_segment(aes(x = x0,
                     xend = x1,
                     y = y0,
                     yend = y1,
                     color = arrow),
                 size = 1.5,
                 arrow = arrow()) +
    # geom_text(aes(x = (x0 + x1) / 2,
    #               y = (y0 + y1) / 2,
    #               label = label)) +
    coord_cartesian(xlim = inWindXlim, ylim = inWindYlim) +
    labs(x = 'X', y = 'Y', color = NULL, title = 'Wind Projected onto Inbound Leg') +
    theme(legend.position = 'bottom',
          plot.caption = element_text(size = 12),
          legend.text = element_text(size = 12))
  
  outFGdf <- segmentsACC %>%
    filter(SegmentID == outLegMeta$SegmentID) %>%
    mutate(FlapGlide = derivedFactor(Flap = varODBA >= 50,
                                     Glide = varODBA < 50),
           i = seq_along(ACCTimestampUTC),
           t = i / first(acc.freq),
           row = (i - 1) %% 6 + 1)
  
  outFGr <- summarize(outFGdf, FGr = sum(FlapGlide == 'Flap', na.rm = TRUE) / (sum(FlapGlide %in% c('Flap', 'Glide'), na.rm = TRUE)))
  
  outFGplot <- ggplot(na.omit(outFGdf), aes(t, ODBA)) +
    geom_line(size = 0.5) +
    geom_point(aes(color = FlapGlide), size = 1) +
    facet_grid(row ~ ., scales = 'free_x') +
    labs(title = 'Outbound Segment ODBA',
         caption = sprintf('Flap/Glide Ratio = %01.2f', outFGr$FGr),
         y = 'Acceleration (m/s^2)') +
    theme_bw(base_size = 10) +
    theme(legend.position = 'none',
          plot.caption = element_text(size = 12))
  
  inFGdf <- segmentsACC %>%
    filter(SegmentID == inLegMeta$SegmentID) %>%
    mutate(FlapGlide = derivedFactor(Flap = varODBA >= 50,
                                     Glide = varODBA < 50),
           i = seq_along(ACCTimestampUTC),
           t = i / first(acc.freq),
           row = (i - 1) %% 6 + 1)
  
  inFGr <- summarize(inFGdf, FGr = sum(FlapGlide == 'Flap', na.rm = TRUE) / (sum(FlapGlide %in% c('Flap', 'Glide'), na.rm = TRUE)))
  
  inFGplot <- ggplot(na.omit(inFGdf), aes(t, ODBA)) +
    geom_line(size = 0.5) +
    geom_point(aes(color = FlapGlide), size = 1) +
    facet_grid(row ~ ., scales = 'free_x') +
    labs(title = 'Inbound Segment ODBA',
         caption = sprintf('Flap/Glide Ratio = %01.2f', inFGr$FGr),
         y = 'Acceleration (m/s^2)') +
    theme_bw(base_size = 10) +
    theme(legend.position = 'bottom',
          plot.caption = element_text(size = 12),
          legend.text = element_text(size = 12)) +
    scale_color_discrete('') +
    guides(color = guide_legend(override.aes = list(size = 4)))

  grid.newpage()
  grid.arrange(grobs = list(mapplot, outWindPlot, inWindPlot, outFGplot, inFGplot), 
               layout_matrix = rbind(c(1, 1, 2, 4),
                                     c(1, 1, 3, 5)))
}

for(tid in unique(inoutSegments$TripID)) {
  p <- plot.trip.WindACC(tid)
  ggsave(sprintf('../TransitSegments/CompPlots/%i.png', tid), p, height = 9, width = 16, units = 'in')
}
```


```{r export}
load('../TransitSegments/segmentsACC.RData')
FGr <- segmentsACC %>%
  group_by(SegmentID) %>%
  mutate(FlapGlide = derivedFactor(Flap = varODBA >= 50,
                                   Glide = varODBA < 50)) %>%
  summarize(Flap = sum(FlapGlide == 'Flap', na.rm = TRUE),
            Glide = sum(FlapGlide == 'Glide', na.rm = TRUE)) %>%
  mutate(FGr = Flap / (Flap + Glide))

segWind <- select(segmentsUV, SegmentID, U, V, tailwind, crosswind)

segSumm <- select(inoutSegments, DeployID, TripID, SegmentID, Start, End, Leg, meanSpd, bearing)

segmentsAll <- segSumm %>%
  left_join(segWind, by = 'SegmentID') %>%
  left_join(FGr, by = 'SegmentID') %>%
  select(-Flap, -Glide) %>%
  mutate(DeployID = factor(DeployID), Leg = factor(Leg)) %>% 
  arrange(SegmentID)

write.csv(segmentsAll, '../TransitSegments/segmentsAll.csv', row.names = FALSE)

tracks <- tidytracks_db %>%
  filter(TripID %in% segmentsAll$TripID) %>%
  select(DeployID, TripID, TimestampUTC, Longitude, Latitude, PositionLag) %>%
  collect(n = Inf) %>%
  mutate(TimestampUTC = as.POSIXct(TimestampUTC, origin = POSIX.origin, tz = 'UTC'))

write.csv(tracks, '../TransitSegments/trips.csv', row.names = FALSE)

save(segmentsAll, tracks, file = '../TransitSegments/segmentsAll.RData')
```

